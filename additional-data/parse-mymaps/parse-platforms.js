const cheerio = require('cheerio')
const fs = require('fs')

let platforms = fs.readFileSync(__dirname + '/station-platforms.kml').toString()
let $ = cheerio.load(platforms)

let knownStations = [
  "Aircraft",
  "Alamein",
  "Albion",
  "Albury",
  "Alphington",
  "Altona",
  "Anstey",
  "Ararat",
  "Ardeer",
  "Armadale",
  "Ascot Vale",
  "Ashburton",
  "Aspendale",
  "Auburn",
  "Bacchus Marsh",
  "Bairnsdale",
  "Balaclava",
  "Ballan",
  "Ballarat",
  "Batman",
  "Baxter",
  "Bayswater",
  "Beaconsfield",
  "Beaufort",
  "Belgrave",
  "Bell",
  "Benalla",
  "Bendigo",
  "Bentleigh",
  "Berwick",
  "Birregurra",
  "Bittern",
  "Blackburn",
  "Bonbeach",
  "Boronia",
  "Box Hill",
  "Brighton Beach",
  "Broadford",
  "Broadmeadows",
  "Brunswick",
  "Bunyip",
  "Burnley",
  "Burwood",
  "Camberwell",
  "Campbelltown",
  "Camperdown",
  "Canterbury",
  "Cardinia Road",
  "Carnegie",
  "Caroline Springs",
  "Carrum",
  "Castlemaine",
  "Caulfield",
  "Chatham",
  "Chelsea",
  "Cheltenham",
  "Clarkefield",
  "Clayton",
  "Clifton Hill",
  "Clunes",
  "Cobblebank",
  "Coburg",
  "Colac",
  "Collingwood",
  "Coolaroo",
  "Cootamundra",
  "Corio",
  "Craigieburn",
  "Cranbourne",
  "Creswick",
  "Crib Point",
  "Croxton",
  "Croydon",
  "Culcairn",
  "Dandenong",
  "Darebin",
  "Darling",
  "Deer Park",
  "Dennis",
  "Diamond Creek",
  "Diggers Rest",
  "Dingee",
  "Donnybrook",
  "Drouin",
  "Eaglehawk",
  "Eaglemont",
  "East Camberwell",
  "East Malvern",
  "East Pakenham",
  "East Richmond",
  "Echuca",
  "Edithvale",
  "Elmore",
  "Elsternwick",
  "Eltham",
  "Epping",
  "Epsom",
  "Essendon",
  "Fairfield",
  "Fawkner",
  "Ferntree Gully",
  "Flagstaff",
  "Flemington Bridge",
  "Flemington Racecourse",
  "Flinders Street",
  "Footscray",
  "Frankston",
  "Gardenvale",
  "Gardiner",
  "Garfield",
  "Geelong",
  "Ginifer",
  "Gisborne",
  "Glen Iris",
  "Glen Waverley",
  "Glenbervie",
  "Glenferrie",
  "Glen Huntly",
  "Glenroy",
  "Goulburn",
  "Gowrie",
  "Greensborough",
  "Gunning",
  "Hallam",
  "Hampton",
  "Harden",
  "Hartwell",
  "Hastings",
  "Hawksburn",
  "Hawkstowe",
  "Hawthorn",
  "Heathcote Junction",
  "Heatherdale",
  "Heathmont",
  "Heidelberg",
  "Henty",
  "Heyington",
  "Highett",
  "Holmesglen",
  "Hoppers Crossing",
  "Hughesdale",
  "Huntingdale",
  "Hurstbridge",
  "Ivanhoe",
  "Jacana",
  "Jewell",
  "Jolimont",
  "Jordanville",
  "Junee",
  "Kananook",
  "Kangaroo Flat",
  "Keilor Plains",
  "Kensington",
  "Keon Park",
  "Kerang",
  "Kilmore East",
  "Kooyong",
  "Kyneton",
  "Laburnum",
  "Lalor",
  "Lara",
  "Laverton",
  "Leawarra",
  "Lilydale",
  "Little River",
  "Longwarry",
  "Lynbrook",
  "Macaulay",
  "Macedon",
  "Macleod",
  "Malmsbury",
  "Malvern",
  "Marshall",
  "Maryborough",
  "McKinnon",
  "Melbourne Central",
  "Melton",
  "Mentone",
  "Merinda Park",
  "Merlynston",
  "Mernda",
  "Merri",
  "Middle Brighton",
  "Middle Footscray",
  "Middle Gorge",
  "Mitcham",
  "Moe",
  "Mont Albert",
  "Montmorency",
  "Moonee Ponds",
  "Moorabbin",
  "Mooroolbark",
  "Mooroopna",
  "Mordialloc",
  "Moreland",
  "Morradoo",
  "Morwell",
  "Moss Vale",
  "Mount Waverley",
  "Murchison East",
  "Murrumbeena",
  "Nagambie",
  "Nar Nar Goon",
  "Narre Warren",
  "Newmarket",
  "Newport",
  "Noble Park",
  "North Brighton",
  "North Geelong",
  "North Melbourne",
  "North Richmond",
  "North Shore",
  "North Williamstown",
  "Northcote",
  "Nunawading",
  "Oak Park",
  "Oakleigh",
  "Officer",
  "Ormond",
  "Pakenham",
  "Parkdale",
  "Parliament",
  "Pascoe Vale",
  "Patterson",
  "Prahran",
  "Preston",
  "Pyramid",
  "Regent",
  "Reservoir",
  "Richmond",
  "Riddells Creek",
  "Ringwood",
  "Ringwood East",
  "Ripponlea",
  "Riversdale",
  "Rochester",
  "Rockbank",
  "Rosanna",
  "Rosedale",
  "Roxburgh Park",
  "Royal Park",
  "Rushall",
  "Ruthven",
  "Sale",
  "Sandown Park",
  "Sandringham",
  "Seaford",
  "Seaholme",
  "Seddon",
  "Seymour",
  "Shepparton",
  "Sherwood Park",
  "Showgrounds",
  "Somerville",
  "South Geelong",
  "South Kensington",
  "South Morang",
  "South Yarra",
  "Southern Cross",
  "Southland",
  "Spotswood",
  "Springvale",
  "St. Albans",
  "Stony Point",
  "Stratford",
  "Strathmore",
  "Sunbury",
  "Sunshine",
  "Surrey Hills",
  "Swan Hill",
  "Sydney Central",
  "Syndal",
  "Talbot",
  "Tallarook",
  "Tarneit",
  "Tecoma",
  "Terang",
  "The Rock",
  "Thomastown",
  "Thornbury",
  "Toorak",
  "Tooronga",
  "Tottenham",
  "Trafalgar",
  "Traralgon",
  "Tyabb",
  "Tynong",
  "Union",
  "Upfield",
  "Upper Ferntree Gully",
  "Upwey",
  "Victoria Park",
  "Wagga Wagga",
  "Wallan",
  "Wandong",
  "Wangaratta",
  "Warragul",
  "Warrnambool",
  "Watergardens",
  "Watsonia",
  "Wattle Glen",
  "Waurn Ponds",
  "Wendouree",
  "Werribee",
  "West Footscray",
  "West Richmond",
  "Westall",
  "Westgarth",
  "Westona",
  "Williams Landing",
  "Williamstown",
  "Williamstown Beach",
  "Willison",
  "Winchelsea",
  "Windsor",
  "Woodend",
  "Wyndham Vale",
  "Yarragon",
  "Yarraman",
  "Yarraville",
  "Yass",
  "Yass Junction"
]

let data = {}

let platformsData = Array.from($('Placemark'))
platformsData.forEach(platform => {
  let stationName = $('Data[name=STATION]', platform).text().trim()
  let platformNumber = $('Data[name=PLATFORM]', platform).text().trim()

  if (!knownStations.includes(stationName)) return console.log('Skipping', stationName)
  if (!platformNumber) return console.log('Skipping', stationName, 'without platform number')

  let coordinatesRaw = $('coordinates', platform).text().trim()
  let coordinates = coordinatesRaw.split('\n').filter(Boolean).map(line => {
    return line.trim().split(',').slice(0, 2).map(x => parseFloat(x))
  })

  let platformGeometry = {
    platformNumber,
    geometry: {
      type: 'Polygon',
      coordinates: [coordinates]
    }
  }

  if (data[stationName]) {
    data[stationName].push(platformGeometry)
  } else {
    data[stationName] = [platformGeometry]
  }
})

fs.writeFileSync(__dirname + '/../station-platform-geometry.json', JSON.stringify(data, null, 1))
